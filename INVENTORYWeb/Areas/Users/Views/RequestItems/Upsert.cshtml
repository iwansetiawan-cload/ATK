@model INVENTORYWeb.Models.ViewModels.RequestItemHeaderViewModel

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var title = "Tambah Data";
}

<div class="pcoded-content">
    <div class="page-header">
        <div class="page-block">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="page-header-title">
                        <h5 class="m-b-10">Transaksi</h5>
                        <p class="m-b-0">List Permintaan Barang</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="page-footer-title text-right">
                        <h4 class="m-b-0"><a href="/" class="text-white">Help</a> </h4>
                    </div>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a asp-area="Users" asp-controller="Home" asp-action=""> <i class="fa fa-home"></i></a></li>
                        <li class="breadcrumb-item"><a asp-area="Users" asp-controller="Index" asp-action="">Home</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="pcoded-inner-content">
        <!-- Main-body start -->
        <div class="main-body">
            <div class="page-wrapper">
                <!-- Page body start -->
                <div class="page-body">
                    <form method="post">
                        <div class="row">
                            <input type="hidden" asp-for="REQUEST_ITEM_HEADER.ID" id="IdHeader" />
                            <input type="hidden" asp-for="REQUEST_ITEM_HEADER.PROJECT_NAME" id="projectName" />
                            @if (Model.REQUEST_ITEM_HEADER.ID != 0)
                            {
                                title = "Edit Data";
                                <input type="hidden" asp-for="REQUEST_ITEM_HEADER.ID" />
                                <input type="hidden" asp-for="REQUEST_ITEM_HEADER.ROW_NUMBER" />
                                <input type="hidden" asp-for="REQUEST_ITEM_HEADER.REQUEST_ORDER_NO" />
                                <input type="hidden" asp-for="REQUEST_ITEM_HEADER.CREATE_BY" />
                                <input type="hidden" asp-for="REQUEST_ITEM_HEADER.CREATE_DATE" />
                                <input type="hidden" asp-for="REQUEST_ITEM_HEADER.STATUS_ID" />
                                <input type="hidden" asp-for="REQUEST_ITEM_HEADER.STATUS" />
                            }
                            <div class="col-sm-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>@title</h5>
                                        @if (Model.REQUEST_ITEM_HEADER.ID != 0)
                                        {
                                            <div class="dropdown-secondary dropdown f-right">

                                                <span class="f-left m-r-5 text-inverse">No Transaksi : <strong class="label label-primary">@Model.REQUEST_ITEM_HEADER.REQUEST_ORDER_NO &nbsp;&nbsp;</strong></span>
                                            </div>
                                        }                                   
                                       
                                    </div>
                                    <div class="card-block">
                                       
                                        <div class="col-12 pt-4">
                                            <div class="form-group row pt-2">

                                                <div class="col-6">
                                                    <div class="form-group row">
                                                        <div class="col-3">
                                                            <label asp-for="REQUEST_ITEM_HEADER.PROJECT_NAME"></label> <span style="color: red">*</span>
                                                        </div>
                                                        <div class="col-9">
                                                            <div class="input-group input-group-button">
                                                                 <input asp-for="REQUEST_ITEM_HEADER.PROJECT_NAME" class="form-control" style="row-gap" id="Show_projectName" disabled />
                                                                <div class="input-group-append">                                                            
                                                                    <button class="btn btn-primary" data-toggle="modal" data-target="#lookupProjectName" type="button"><i class="fa fa-binoculars"></i></button>
                                                                </div>
                                                            </div>
                                                      @*       <span asp-validation-for="REQUEST_ITEM_HEADER.PROJECT_NAME" class="text-danger"></span> *@
                                                        </div>
                                                        
                                                    </div>

                                                </div>
                                              
                                                <div class="col-6">
                                                    <div class="form-group row">
                                                        <div class="col-3">
                                                            <label asp-for="REQUEST_ITEM_HEADER.REQUEST_DATE"></label>
                                                        </div>
                                                        <div class="col-9">
                                                            <input asp-for="REQUEST_ITEM_HEADER.REQUEST_DATE" class="form-control" type="date" />
                                                            <span asp-validation-for="REQUEST_ITEM_HEADER.REQUEST_DATE" class="text-danger"></span>
                                                        </div>
                                                    </div>

                                                </div>
                                            </div>
                                            <div class="form-group row pt-2">
                                                <div class="col-6">
                                                    <div class="form-group row">
                                                        <div class="col-3">
                                                            <label asp-for="REQUEST_ITEM_HEADER.NOTES"></label>
                                                        </div>
                                                        <div class="col-9">
                                                            <textarea asp-for="REQUEST_ITEM_HEADER.NOTES" class="form-control" style="row-gap"></textarea>
                                                            <span asp-validation-for="REQUEST_ITEM_HEADER.NOTES" class="text-danger"></span>
                                                        </div>
                                                    </div>

                                                </div>
                                               
                                            </div>


                                        </div>

                                        <div class="col-12 border-bottom">
                                            <h1 class="text-primary"></h1>
                                        </div>
                                     @*    <a asp-action="Index" class="btn btn-danger btn-outline-danger f-right previous m-b-10 btn-sm"><i class="icofont icofont-ui-close"></i>Cancel</a> *@
                                       @*  <a class="btn waves-effect waves-light btn-warning f-right m-r-10" style="color:white" onclick="ExportPDF()"><i class="icofont icofont-ui-close"></i>Cancel</a> *@

                                        <div class="card-block">
                                            <input type="hidden" value="REQUEST_ITEM_DETAIL.ID" id="idItem" />
                                            <div class="dt-responsive table-responsive">
                                                <table id="tblData" class="table table-striped table-bordered nowrap" style="width:100%">
                                                    <thead>
                                                        <tr>
                                                            <th>
                                                                Nama Item
                                                            </th>

                                                            <th>
                                                                Satuan
                                                            </th>

                                                            <th>
                                                                Isi
                                                            </th>
                                                            <th>
                                                            </th>
                                                            <th>
                                                                Stok
                                                            </th>
                                                            <th>
                                                                Jumlah
                                                            </th>
                                                            <th>
                                                            </th>
                                                        </tr>
                                                        <tr>
                                                            <th>
                                                                <input asp-for="REQUEST_ITEM_DETAIL.ITEM_NAME" id="namaBarang" class="form-control" disabled />
                                                            </th>

                                                            <th>
                                                                <input asp-for="REQUEST_ITEM_DETAIL.CATEGORY" id="satuan" class="form-control" disabled />
                                                            </th>
                                                            <th>
                                                                <input asp-for="REQUEST_ITEM_DETAIL.PIECE" id="isi" class="form-control" disabled />
                                                            </th>
                                                            <th style="width:5%">
                                                                <button type="button" class="btn btn-primary btn-sm waves-effect" data-toggle="modal" data-target="#lookupItems"><i class="fa fa-binoculars"></i></button>                                                              
                                                            </th>
                                                            <th>
                                                                <input asp-for="REQUEST_ITEM_DETAIL.STOCK" type="number" class="form-control" style="row-gap" id="stock" />
                                                            </th>
                                                            <th>
                                                                <input asp-for="REQUEST_ITEM_DETAIL.QTY" type="number" class="form-control" style="row-gap" id="quantity" />
                                                            </th>
                                                            <th style="width:5%">
                                                                <button class="btn btn-success btn-sm" type="button"  onclick="addItem()"><i class="icofont icofont-plus"></i></button>
                                                            </th>
                                                        </tr>
                                                     
                                                    </thead>

                                                </table>
                                            </div>

                                            <div class="row text-right">
                                                <div class="col-sm-8">
                                                </div>
                                                <div class="col-sm-4 text-right">
                                                    <div class="form-group row">
                                                        <label class="col-sm-4 col-form-label">Total Qty :</label>
                                                        <div class="col-sm-8">
                                                            <input asp-for="REQUEST_ITEM_HEADER.TOTAL_QTY" class="form-control" style="row-gap" asp-format="{0:#,###}" id="TotalQty" readonly />
                                                        </div>
                                                    </div>                                                   

                                                </div>                                               
                                            </div>
                                        </div>

                                    </div>
                                </div>

                                <div class="row text-center">
                                    <div class="col-sm-12 invoice-btn-group text-center">
                                        <button type="submit" class="btn btn-primary btn-print-invoice m-b-10 btn-sm waves-effect waves-light m-r-20"><i class="icofont icofont-save"></i>Simpan</button>
                                        @if (Model.REQUEST_ITEM_HEADER.ID != 0)
                                        {
                                            <button class="btn waves-effect waves-light btn-inverse m-b-10 btn-sm" asp-action="Index"><i class="icofont icofont-undo"></i>Kembali</button>
                                     @*        <button class="btn btn-danger waves-effect m-b-10 btn-sm waves-light" asp-action="Index"><i class="icofont icofont-undo"></i>Kembali</button> *@
                                        }
                                        else
                                        {
                                            <a type="button" class="btn btn-danger waves-effect m-b-10 btn-sm waves-light" asp-action="Index"><i class="icofont icofont-ui-close"></i>Batal</a>
                                        }
                                        
                                        
                                    </div>

                                </div>
                            </div>
                           
                            <!-- Page body end -->

                        </div>
                    </form>


                </div>
            </div>
        </div>

    </div>
</div>

<div class="md-overlay"></div>


<!-- Modal -->
<div class="modal fade" id="lookupProjectName" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="lookupProjectLabel">Cari Data Project</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">          
                <div class="card">

                    <div class="card-block">
                        <div class="dt-responsive table-responsive">
                            <table id="tblDataMasterProject" class="table table-striped table-bordered nowrap" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Nama</th>                                  
                                        <th style="display:none">Id</th>
                                    </tr>
                                </thead>

                            </table>
                        </div>

                    </div>
                </div>
            </div>
           
        </div>
    </div>
</div>


<div class="modal fade" id="lookupItems" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="lookupItemsLabel">Cari Data Barang</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card">

                    <div class="card-block">
                        <div class="dt-responsive table-responsive">
                            <table id="tblDataMasterItems" class="table table-striped table-bordered nowrap" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Nama</th>
                                        <th>Satuan</th>
                                        <th>Isi</th>
                                        <th>Keterangan</th>
                                        <th style="display:none">Id</th>
                                    </tr>
                                </thead>

                            </table>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </div>
</div>


@section Scripts {

@*     <partial name="_ValidationScriptsPartial" /> *@
     
    <script type="text/javascript">
     
      
        $(document).ready(function () {
            loadDataAddItems();
            loadDataMasterItem();
            loadDataMasterProject();
        });       

        function loadDataMasterItem() {
            dataTable = $('#tblDataMasterItems').DataTable({
                "ajax": {
                    "url": "/Users/RequestItems/GetAllMasterItems",
                    'method': "GET"
                },
                "columns": [
                    { "data": "name", "autoWidth": true },
                    { "data": "category.name", "autoWidth": true },
                    { "data": "piece", "autoWidth": true },
                    { "data": "description", "autoWidth": true },
                     { "data": "id", "autoWidth": true }
                    
                ],
                "createdRow": function (row, data, index) {
                    $(row).attr('onclick', 'select_row(this)');
                    $(row).attr('data-dismiss', 'modal');
                    $('td', row).eq(4).attr('style', 'display:none;');
                }
            });
        }
        function select_row(obj) {
            var Item = $('td', obj).eq(0).html().trim();
            var Satuan = $('td', obj).eq(1).html().trim();
            var Isi = $('td', obj).eq(2).html().trim();
            var Id = $('td', obj).eq(4).html().trim();

            $('#namaBarang').val(Item);
            $('#satuan').val(Satuan);
            $('#isi').val(Isi);
            $('#idItem').val(Id);
        }

        function loadDataMasterProject() {
            dataTable = $('#tblDataMasterProject').DataTable({
                "ajax": {
                    "url": "/Users/RequestItems/GetAllMasterProject",
                    'method': "GET"
                },
                "columns": [
                    { "data": "project_name", "autoWidth": true }
                    
                ],
                "createdRow": function (row, data, index) {
                    $(row).attr('onclick', 'select_row_project(this)');
                    $(row).attr('data-dismiss', 'modal');
                }
            });
        }

        function select_row_project(obj) {
            var name = $('td', obj).eq(0).html().trim();
            $('#projectName').val(name);
            $('#Show_projectName').val(name);
        }

        function addItem() {

            var id = $("#idItem").val();
            var stok = $("#stock").val();
            var qty = $("#quantity").val();

            if (id != "" && qty != "") {
                var urls = "/Users/RequestItems/AddItem?id=" + id + "&qty=" + qty + "&stock=" + stok;

                try {
                    $.ajax({
                        url: urls,
                        dataType: 'json',
                        type: 'POST',
                        contentType: 'application/json;',
                        success: function (data) {
                            if (data.result == "true") {
                                dataTable.ajax.reload();
                                loadDataAddItems();
                                $("#idItem").val('');
                                $("#namaBarang").val('');
                                $("#satuan").val('');
                                $("#isi").val('');
                                $("#stock").val(''); 
                                $("#quantity").val('');
                                $("#TotalQty").val(data.total_qty);
                            }

                        },
                        error: function (request, status, error) {
                            console.log(status);
                            console.log(urls, status, error.toString());
                            console.log("error" + error);

                        }
                    });

                } catch (e) {

                }
            }


        }
        function loadDataAddItems() {
            // var id = $('#idItem').val();
            // var idheader = $('#IdHeader').val();
            var table = $('#tblData').DataTable();
            table.clear().draw();     
            table.destroy();
            table = $('#tblData').DataTable({              
                "ajax": {
                    "url": "/Users/RequestItems/GetAllItems"
                    // "data": {
                    //     "id": id,
                    //     "idHeader": idheader
                    // }
                },
                "paging": false,
                "searching": false,
                "columns": [
                    { "data": "name", "autoWidth": true },
                    { "data": "satuan", "autoWidth": true },
                    { "data": "piece", "autoWidth": true },
                    { "data": "norow", "autoWidth": true },
                    { "data": "stock", "autoWidth": true },
                    { "data": "qty", "autoWidth": true },                 
                    {
                    "data": "id",
                    "render": function (data) {
                        return `
                                <div class="text-center">
                                    <a onclick=removeItem("${data}") class="btn btn-success btn-mini b-none text-white" style="cursor:pointer" title="delete">
                                        <i class="icofont icofont-minus"></i>
                                    </a>                                   
                                </div>
                                `;
                        }, "autoWidth": true
                    }
                ],
                "createdRow": function (row, data, index) {
                    $('td', row).eq(2).attr("style", "text-align: right");
                    $('td', row).eq(4).attr("style", "text-align: right");
                    $('td', row).eq(5).attr("style", "text-align: right");
                }
            });
        }

        function removeItem(id) {
            var urls = "/Users/RequestItems/DeleteItem?id=" + id;

            try {
                $.ajax({
                    url: urls,
                    dataType: 'json',
                    type: 'DELETE',
                    contentType: 'application/json;',
                    success: function (data) {
                        if (data.result == "true") {
                            dataTable.ajax.reload();
                            loadDataAddItems();
                            $("#TotalQty").val(data.total_qty);
                        }

                    },
                    error: function (request, status, error) {
                        console.log(status);
                        console.log(urls, status, error.toString());
                        console.log("error" + error);

                    }
                });

            } catch (e) {

            }

        }

    </script>

}
